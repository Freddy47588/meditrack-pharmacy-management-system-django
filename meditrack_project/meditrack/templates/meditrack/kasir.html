<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaksi Kasir</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <!-- HEADER -->
    <header class="bg-blue-600 text-white py-4 px-6 shadow">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold">üßæ Transaksi Kasir</h1>

        <!-- BACK BUTTON -->
        <a
          href="/"
          class="bg-white text-blue-600 font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-100 transition"
        >
          ‚Üê Kembali
        </a>
      </div>
    </header>

    <!-- CONTAINER -->
    <div class="max-w-5xl mx-auto mt-8 p-6">
      <!-- ALERT ERROR -->
      {% if formset.non_form_errors %}
      <div
        class="bg-red-100 text-red-700 p-4 mb-4 rounded-lg border border-red-300"
      >
        {% for err in formset.non_form_errors %}
        <p>{{ err }}</p>
        {% endfor %}
      </div>
      {% endif %}

      <!-- FORM WRAPPER -->
      <form
        method="post"
        id="kasir-form"
        class="bg-white shadow-lg rounded-xl p-6 space-y-6 border border-gray-200"
      >
        {% csrf_token %} {{ formset.management_form }}

        <h2 class="text-xl font-semibold mb-2 text-gray-700">
          Input Pembelian Obat
        </h2>

        <p class="text-gray-600 mb-4">
          Silakan pilih obat dan masukkan jumlah pembeliannya.
        </p>

        <!-- TABEL -->
        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="min-w-full" id="kasir-table">
            <thead class="bg-gray-100 border-b">
              <tr>
                <th class="px-4 py-3 text-left w-2/3 font-medium text-gray-700">
                  Nama Obat
                </th>
                <th class="px-4 py-3 text-left w-1/3 font-medium text-gray-700">
                  Jumlah
                </th>
                <th class="px-4 py-3 text-center font-medium text-gray-700">
                  Aksi
                </th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-200" id="formset-body">
              {% for form in formset %}
              <tr class="hover:bg-gray-50 transition form-row">
                <!-- OBAT -->
                <td class="px-4 py-3">
                  <label class="text-gray-700 font-medium">Pilih Obat</label>
                  <div class="relative">{{ form.obat }}</div>
                  <p class="text-xs text-gray-500">
                    Pilih obat sesuai stok tersedia.
                  </p>
                </td>

                <!-- JUMLAH -->
                <td class="px-4 py-3">
                  <label class="text-gray-700 font-medium">Jumlah Beli</label>
                  {{ form.jumlah }} {% if form.jumlah.errors %}
                  <p class="text-red-500 text-xs">{{ form.jumlah.errors.0 }}</p>
                  {% endif %}
                </td>
                <td class="px-4 py-3 text-center">
                  <button
                    type="button"
                    class="hapus-row bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 transition shadow text-sm"
                  >
                    Hapus
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- BUTTON TAMBAH BARIS -->
        <div class="flex justify-start">
          <button
            type="button"
            id="add-row"
            class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition shadow"
          >
            + Tambah Obat
          </button>
        </div>

        <!-- BUTTON SUBMIT -->
        <div class="mt-6 flex justify-end">
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-lg font-semibold transition"
          >
            Proses Transaksi
          </button>
        </div>
      </form>
    </div>

    <script>
      // Disable obat stok 0
      document.addEventListener("DOMContentLoaded", function () {
        const selects = document.querySelectorAll("select");

        selects.forEach((select) => {
          for (let option of select.options) {
            if (option.text.includes("Stok: 0")) {
              option.disabled = true;
              option.style.color = "red";
              option.text += " (Habis)";
            }
          }
        });
      });

      // Tambah baris formset
      document.getElementById("add-row").addEventListener("click", function () {
        const formsetBody = document.getElementById("formset-body");
        const totalForms = document.querySelector("#id_form-TOTAL_FORMS");

        let newIndex = Number(totalForms.value);

        // Clone row 0 (template)
        let newRow = document.querySelector(".form-row").cloneNode(true);

        // Reset value dropdown & jumlah
        newRow.querySelectorAll("select, input").forEach((input) => {
          input.name = input.name.replace(/form-\d+-/, `form-${newIndex}-`);
          input.id = input.id.replace(/form-\d+-/, `form-${newIndex}-`);

          if (input.tagName === "SELECT") {
            input.selectedIndex = 0;
          }
          if (input.tagName === "INPUT") {
            input.value = "";
          }
        });

        formsetBody.appendChild(newRow);
        totalForms.value = newIndex + 1;
      });

      // Hapus baris formset
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("hapus-row")) {
          const rows = document.querySelectorAll(".form-row");

          // Minimal harus tersisa 1 baris
          if (rows.length === 1) {
            alert("Minimal harus ada satu baris pembelian!");
            return;
          }

          // Hapus baris
          let row = e.target.closest("tr");
          row.remove();

          // Update indeks formset
          const totalForms = document.querySelector("#id_form-TOTAL_FORMS");
          let currentCount = document.querySelectorAll(".form-row").length;
          totalForms.value = currentCount;

          // Perbaiki index name/id setiap baris
          document.querySelectorAll(".form-row").forEach((row, index) => {
            row.querySelectorAll("select, input").forEach((input) => {
              input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
              input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
            });
          });
        }
      });
    </script>
  </body>
</html>
